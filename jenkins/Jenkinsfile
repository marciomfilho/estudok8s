pipeline {
  agent any
  environment {
    GCP_PROJECT = 'careful-airfoil-470112-u0'
    GCP_ZONE = 'us-central1-a'
    GCP_CLUSTER = 'cluster-zabbix-grafana'
    NAMESPACE = 'monitoring'
  }
  stages {
    stage('Provisionar Infraestrutura') {
      steps {
        withCredentials([file(credentialsId: 'gcp-service-account-key', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
          dir('terraform') {
            sh 'gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS'
            sh 'terraform init'
            sh 'terraform apply -auto-approve'
          }
        }
      }
    }
    stage('Configurar kubectl') {
      steps {
        withCredentials([file(credentialsId: 'gcp-service-account-key', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
          sh 'gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS'
          sh 'gcloud container clusters get-credentials $GCP_CLUSTER --zone $GCP_ZONE --project $GCP_PROJECT'
        }
      }
    }
    stage('Criar Namespace') {
      steps {
        sh 'kubectl apply -f k8s-manifests/namespaces.yaml'
      }
    }
    stage('Deploy Zabbix via Helm') {
      steps {
        dir('helm/zabbix') {
          sh 'helm repo add zabbix-community https://zabbix-community.github.io/helm-zabbix'
          sh 'helm repo update'
          sh 'helm upgrade --install zabbix zabbix-community/zabbix -f values.yaml --namespace $NAMESPACE --create-namespace --dependency-update'
        }
      }
    }
    stage('Deploy Grafana via Helm') {
      steps {
        dir('helm/grafana') {
          sh 'helm repo add grafana https://grafana.github.io/helm-charts'
          sh 'helm repo update'
          sh 'helm upgrade --install grafana grafana/grafana -f values.yaml --namespace $NAMESPACE'
        }
      }
    }
    stage('Aplicar Ingress') {
      steps {
        sh 'kubectl apply -f k8s-manifests/ingress.yaml'
      }
    }
  }
}
// Fim do arquivo Jenkinsfile