pipeline {
  agent any
  environment {
    PROJECT_ID   = 'careful-airfoil-470112-u0'
    CLUSTER_NAME = 'cluster-zabbix-grafana'
    CLUSTER_ZONE = 'us-central1-a'
    NAMESPACE    = 'monitoring'
    GCLOUD_BIN   = '/Users/marcio/Downloads/google-cloud-sdk/bin/gcloud'
    REPO_ROOT    = '/Users/marcio/Documents/repositorio/estudok8s'
  }
  stages {
    stage('Autenticar GCP') {
      steps {
        withCredentials([file(credentialsId: 'gcp-service-account-key', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
          sh '''
            $GCLOUD_BIN auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          '''
        }
      }
    }
    stage('Configurar kubectl') {
      steps {
        sh "$GCLOUD_BIN container clusters get-credentials $CLUSTER_NAME --zone $CLUSTER_ZONE --project $PROJECT_ID"
      }
    }
    stage('Criar Namespace e Policies') {
      steps {
        sh """
          kubectl get namespace $NAMESPACE || kubectl create namespace $NAMESPACE
          kubectl apply -f $REPO_ROOT/network-policy.yaml -n $NAMESPACE
        """
      }
    }
    stage('Deploy Zabbix Agent Config e DaemonSet') {
      steps {
        sh """
          kubectl apply -f $REPO_ROOT/zabbix-agent-config.yaml -n $NAMESPACE
          kubectl apply -f $REPO_ROOT/zabbix-agent-daemonset.yaml -n $NAMESPACE
          kubectl rollout restart daemonset zabbix-agent -n $NAMESPACE
        """
      }
    }
    stage('Deploy Zabbix via Helm') {
      steps {
        sh """
          helm repo add zabbix-community https://zabbix-community.github.io/helm-zabbix
          helm repo update
          helm upgrade --install zabbix zabbix-community/zabbix -f $REPO_ROOT/values.yaml --namespace $NAMESPACE --wait
        """
      }
    }
    stage('Expose Zabbix Web') {
      steps {
        sh "kubectl apply -f $REPO_ROOT/zabbix-loadbalancer.yaml -n $NAMESPACE"
      }
    }
  }
}
